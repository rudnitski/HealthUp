# PRD v4.2 (MVP) â€” Chat Plot Thumbnails

## Status
MVP scope â€” approved for implementation

---

## Motivation

At the current MVP stage, HealthUp has three UX problems related to analytical results:

1. **Loss of causality**  
   Plots appear outside the chat, weakening the connection between a userâ€™s question and its answer.

2. **Information overload**  
   Users immediately see a full interactive chart and full table before understanding what changed or whether it matters.

3. **Poor scannability in multi-turn chats**  
   When several plots are generated, there is no visual trace of results inside the conversation itself.

This PRD introduces a **minimal thumbnail summary for plots**, rendered directly in the chat, to fix these problems with minimal engineering cost.

---

## Goals (MVP)

### Primary
- Visually anchor each plot result inside the chat message that produced it
- Provide immediate semantic value before the user inspects the full chart

### Secondary
- Reduce cognitive load by summarizing â€œwhat changedâ€
- Preserve existing plot rendering unchanged

---

## Non-Goals (Explicit)

The following are **out of scope for v4.2 MVP**:

- Table thumbnails
- Distribution / histogram thumbnails
- Data quality flags beyond simple status
- LLM-driven thumbnail generation
- Structured output schemas
- Thumbnail â†” plot synchronization
- Multiple thumbnail types
- Thumbnail click behavior
- Refactoring existing plot UI

---

## Core Principle (MVP)

**One plot â†’ one deterministic thumbnail â†’ rendered inside chat**

The thumbnail is always derived from the plot data already produced.

---

## High-Level Flow (MVP)

User prompt  
â†’ LLM generates SQL + plot query  
â†’ Backend executes SQL and produces plot rows (existing behavior)  
â†’ Backend deterministically derives a thumbnail from those rows  
â†’ Backend emits a single `plot_result` SSE with `{ rows + thumbnail }`  
â†’ Chat renders assistant text + thumbnail  
â†’ Existing full plot renders unchanged

The thumbnail is never generated by the LLM in v4.2.

---

## Supported Scope (Strict)

### Supported
- **Time-series plots only**
- Single- or multi-analyte plots are treated identically
- Thumbnail always represents the analyte initially shown in the plot

### Explicitly not inferred
- Dominant analyte by heuristics
- Clinical importance
- Data quality beyond basic range status

---

## Thumbnail Contract (Minimal, Enforced)

The backend MUST attach a thumbnail object with the following shape.

```ts
thumbnail: {
  kind: "plot_thumbnail_v1",
  title: string,                // plot_title
  point_count: number,          // number of points in focus series
  focus_label?: string | null,  // analyte label if multi-series
  latest_value?: number | null,
  unit?: string | null,
  status: "normal" | "high" | "low" | "unknown",
  delta_text?: string | null,   // e.g. "â†“ -12% (2y)"
  series: number[]              // required, 1..30 values
}
```

### Required fields
- `kind`
- `title`
- `status`
- `point_count`
- `series`

All other fields may be `null`.

---

## Thumbnail Derivation Rules (Backend)

The backend is solely responsible for computing thumbnails.

### Focus series selection
- If the plot contains multiple analytes, select the same analyte used as the **default series in the plot UI**.
- Current default behavior (alphabetical by label) must be reused to keep thumbnail and plot consistent.

### Downsampling
- If `n â‰¤ 30` points â†’ use all points.
- If `n > 30` â†’ sample evenly across the series:
  - always include first and last
  - select remaining points by fixed stride

### Latest value
- Use the last value in the focus series.
- If no numeric value exists â†’ `null`.

### Delta text
- If fewer than 2 points â†’ `null`.
- Otherwise compute percentage change from first â†’ last:
  - `(last - first) / abs(first)` when `first â‰  0`
- Format: `â†‘ +12% (2y)` or `â†“ -8% (6m)` with rounded duration.

### Status
- If reference bounds exist and the latest value is out of range:
  - above upper â†’ `high`
  - below lower â†’ `low`
- If in range â†’ `normal`
- If reference data missing or ambiguous â†’ `unknown`

---

## Thumbnail UI (Chat)

### Purpose
Answer three questions instantly:
1. What is this plot about?
2. Where is the latest value?
3. Is it trending up or down?

### Layout (Fixed)

```
ğŸ“ˆ Plot title
Latest: <value> <unit>   â— <status>
<delta text>
<sparkline>
```

Example:

```
ğŸ“ˆ Vitamin D (25-OH)
Latest: 40.6 ng/ml   â— Normal
â†“ âˆ’12% (2y)
â–‚â–ƒâ–…â–†â–…â–ƒâ–‚â–ƒ
```

### Visual Rules
- Sparkline only (no axes, no labels)
- Sparkline height â‰ˆ 18px
- Neutral colors; status indicated by a small dot
- Compact card; no interactions

---

## Transport & Identification

The existing `plot_result` SSE payload is extended with:

```json
{
  "type": "plot_result",
  "result_id": "<uuid>",
  "anchor_msg_id": "<assistant_message_id>",
  "plot_title": "...",
  "rows": [...],
  "thumbnail": { ... }
}
```

Rules:
- `result_id` uniquely identifies the plot result.
- `anchor_msg_id` identifies the assistant message this plot answers.
- One or more `plot_result` events per assistant message are allowed.

---

## Frontend Rendering Rules

### Insertion point
- The thumbnail MUST be rendered inside the chat stream.
- It is appended to the assistant message identified by `anchor_msg_id`.
- Existing plot rendering into `#sqlResults` remains unchanged.

### Component
- `ChatPlotThumbnail` renders `plot_thumbnail_v1`.

### Non-responsibilities (explicit)
Frontend must NOT:
- compute deltas
- infer trends
- choose focus analyte
- read raw plot rows to derive thumbnails
- render multiple series

---

## Fallback Behavior (Deterministic)

A thumbnail anchor MUST always be shown.

If thumbnail derivation fails or required fields are missing, render a generic fallback card:

```
ğŸ“ˆ <plot_title>
<point_count> points
Open chart below
```

Plot rendering must never be blocked.

---

## Backward Compatibility

- Existing plot UI remains untouched
- No change to SQL generation or validation
- Feature is additive and removable

---

## Success Criteria (MVP)

- Every plot result has a visible anchor inside chat
- Users understand â€œwhat changedâ€ before inspecting the full chart
- Multi-turn chats remain scannable
- Implementation is straightforward for a mid-level engineer

---

## Explicit Future Work (Not This PRD)

- LLM-generated thumbnails
- Structured output schemas
- Data quality flags
- Table thumbnails
- Thumbnail â†” plot coalescing
- Hover / click interactions
