# Example environment configuration for HealthUp
# Copy this file to `.env` and fill in real values

# OCR Provider Configuration (PRD v2.7)
OCR_PROVIDER=openai                        # Options: openai, anthropic
OPENAI_API_KEY=your-openai-key-here        # OpenAI API key (required for OpenAI OCR and SQL generation)
OPENAI_VISION_MODEL=gpt-5-mini             # OpenAI vision model name
OPENAI_USE_NATIVE_PDF=false                # Experimental: Use native PDF input for OpenAI (true/false, default: false)
ANTHROPIC_API_KEY=your-anthropic-key-here  # Anthropic API key (required for Anthropic OCR)
ANTHROPIC_VISION_MODEL=claude-sonnet-4-5-20250929  # Anthropic vision model name

# Vision Provider Fallback
# Automatically fallback to alternate provider if primary exhausts all retries with rate limit/overload errors
VISION_FALLBACK_ENABLED=false              # Enable fallback (requires both API keys configured)

# Authentication Database Roles (PRD v4.4.1)
# Part 1: DATABASE_URL should use healthup_owner credentials
# Part 3: Switch DATABASE_URL to healthup_app credentials, keeping DATABASE_APP_URL for reference
DATABASE_URL=postgres://USER:PASSWORD@localhost:5432/DBNAME
DATABASE_APP_URL=postgres://healthup_app:app_password@localhost:5432/healthup    # Application role (RLS-enforced)
ADMIN_DATABASE_URL=postgres://healthup_admin:admin_password@localhost:5432/healthup  # Admin role (bypasses RLS)

# Session Management (PRD v4.4.2)
SESSION_TTL_MS=1209600000                 # 14 days in milliseconds (session absolute expiry)
SESSION_CLEANUP_INTERVAL_MS=3600000       # 1 hour cleanup interval (removes expired sessions)
SESSION_CACHE_MAX=10000                   # Max cached sessions in memory (LRU cache)

# Admin Authorization (PRD v4.4.2)
# Comma-separated list of email addresses allowed to access admin endpoints
ADMIN_EMAIL_ALLOWLIST=admin@example.com

# Runtime Configuration
PORT=3000                                  # Server port
LOG_LEVEL=info                             # Logging level (debug, info, warn, error)
PDFTOPPM_PATH=pdftoppm                     # Path to pdftoppm binary for PDF conversion
REQUIRE_PG_TRGM=true                       # Require pg_trgm extension for fuzzy search
SHUTDOWN_TIMEOUT_MS=5000                   # Grace period before forcing socket close on shutdown (default 5000ms)

# File Storage Configuration (PRD v3.4)
# Path where uploaded lab report files are stored
# FILE_STORAGE_PATH=/path/to/storage/directory
# Default: {project_root}/storage/lab_reports
#
# Localhost: Use default or specify local path
# FILE_STORAGE_PATH=./storage/lab_reports
#
# VPS/Production: Specify absolute path with sufficient storage
# FILE_STORAGE_PATH=/var/www/healthup/storage/lab_reports
# FILE_STORAGE_PATH=/mnt/storage/healthup/lab_reports
# Example for Contabo VPS with 150GB:
# FILE_STORAGE_PATH=/home/healthup/storage/lab_reports

# Mapping Applier Configuration (PRD v2.4)
# Automatic analyte mapping is always enabled after lab report upload
ENABLE_MAPPING_WRITE=true             # Enable automatic mapping writes to database
ENABLE_MAPPING_DRY_RUN=false          # Dry-run mode (logs only, no DB writes)
MAPPING_AUTO_ACCEPT=0.85              # Confidence threshold for auto-accept
MAPPING_QUEUE_LOWER=0.60              # Lower bound for review queue
BACKFILL_SIMILARITY_THRESHOLD=0.70    # Minimum fuzzy similarity to accept
ANALYTE_MAPPING_MODEL=gpt-5-mini      # LLM model for Tier C analyte mapping (falls back to SQL_GENERATOR_MODEL)

# SQL Generator Configuration (v0.9.2+)
SQL_GENERATION_ENABLED=true           # Feature flag to enable/disable SQL generation
SQL_GENERATOR_MODEL=gpt-5-mini        # Default model for SQL generation (agentic mode, legacy endpoint)
CHAT_MODEL=gpt-5.1                    # Model for conversational chat interface (PRD v3.2, defaults to SQL_GENERATOR_MODEL)
CHAT_MAX_TOKEN_THRESHOLD=50000        # Token limit for conversation history pruning (default: 50000)
CHAT_KEEP_RECENT_MESSAGES=20          # Number of messages to keep when pruning history (default: 20)
ALLOW_MODEL_OVERRIDE=false            # Allow per-request model override (dev only)
SQL_SCHEMA_CACHE_TTL_MS=300000        # Schema cache TTL in ms (5min prod, 1min dev)
SCHEMA_WHITELIST=public               # Comma-separated list of allowed schemas
SQLGEN_MAX_JOINS=8                    # Maximum number of JOINs allowed
SQLGEN_MAX_SUBQUERIES=2               # Maximum nested subquery depth
SQLGEN_MAX_AGG_FUNCS=10               # Maximum number of aggregate functions
SQLGEN_RATE_LIMIT_PER_IP=60           # Requests per minute per IP
SQL_VALIDATION_BYPASS=false           # Disable SQL validator (set true only for local debugging)
ADMIN_API_KEY=your-secret-admin-key   # Admin API key for cache busting

# Agentic SQL Generation (v2.0, POC)
AGENTIC_SQL_ENABLED=true              # Enable agentic exploration mode (feature flag)
AGENTIC_MAX_ITERATIONS=5              # Maximum tool-calling iterations per query
AGENTIC_FUZZY_SEARCH_LIMIT=20         # Max results per fuzzy search tool call
AGENTIC_EXPLORATORY_SQL_LIMIT=20      # Max rows for exploratory SQL queries

# SQL Query Limits (enforced by validator and chatStream)
SQL_VALIDATOR_PLOT_LIMIT=10000        # Max rows for plot queries (time-series visualizations)
SQL_VALIDATOR_TABLE_LIMIT=500         # Max rows for table queries (increased from 50 for better data access)
SQL_VALIDATOR_EXPLORATORY_LIMIT=20    # Max rows for exploratory queries (data discovery)
AGENTIC_SIMILARITY_THRESHOLD=0.3      # pg_trgm similarity threshold (0.0-1.0)
AGENTIC_TIMEOUT_MS=120000             # Total timeout for agentic loop (2 minutes - allows for slow OpenAI responses)

# Gmail Integration (PRD v2.9, Dev-only)
GMAIL_INTEGRATION_ENABLED=false                    # Set to true to enable Gmail integration
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
GMAIL_TOKEN_PATH=./server/config/gmail-token.json  # Auto-created
GMAIL_MAX_EMAILS=200                               # Max emails to fetch
GMAIL_CONCURRENCY_LIMIT=20                         # Concurrent Gmail API requests
GMAIL_RATE_LIMIT_MAX_RETRIES=5                     # Max retry attempts for Gmail API rate limit errors (default: 5)
GMAIL_RATE_LIMIT_INITIAL_DELAY_MS=60000            # Initial retry delay in ms, doubles each retry: 60s, 120s, 240s... (default: 60000)
GMAIL_OAUTH_REDIRECT_URI=http://localhost:3000/api/dev-gmail/oauth-callback
EMAIL_CLASSIFIER_MODEL=gpt-5-mini                  # Optional, defaults to SQL_GENERATOR_MODEL
EMAIL_CLASSIFIER_CONCURRENCY=6                     # Parallel OpenAI requests for Step-1 metadata classification
EMAIL_CLASSIFIER_BATCH_SIZE=25                     # Emails per OpenAI request for Step-1 metadata classification (default: 25, max recommended: 50)
EMAIL_CLASSIFIER_MAX_RETRIES=3                     # Retry attempts per batch
EMAIL_CLASSIFIER_RETRY_DELAY_MS=1000               # Initial retry delay (ms), doubles per attempt

# Gmail Integration Step-2 (Body & Attachment Analysis)
GMAIL_MAX_BODY_CHARS=8000                                    # Max body text characters (default 8000)
GMAIL_BODY_ACCEPT_THRESHOLD=0.70                             # LLM confidence threshold (default 0.70)
GMAIL_ALLOWED_MIME=application/pdf,image/png,image/jpeg,image/jpg,image/heic
GMAIL_MAX_ATTACHMENT_MB=15                                   # Max attachment size in MB (default 15)

# Gmail Integration Step-3 (Attachment Ingestion)
GMAIL_ATTACHMENT_INGEST_ENABLED=true                         # Enable Step-3 routes
GMAIL_DOWNLOAD_CONCURRENCY=5                                 # Max concurrent downloads (rate limit safety)
GMAIL_ATTACHMENT_TIMEOUT_MS=300000                           # Timeout per attachment (5 min)
GMAIL_BATCH_MAX_ATTACHMENTS=20                               # Max attachments per batch
