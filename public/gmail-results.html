<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gmail Ingestion Results - HealthUp</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .results-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 2rem;
    }

    .summary-box {
      background: #f5f5f5;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }

    .summary-stats {
      display: flex;
      gap: 2rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.2rem;
    }

    .actions {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }

    .btn-secondary {
      background-color: #6b7280;
      color: white;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
    }

    .results-table th,
    .results-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .results-table th {
      background-color: #f0f0f0;
      font-weight: bold;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: bold;
    }

    .status-completed {
      background-color: #4CAF50;
      color: white;
    }

    .status-updated {
      background-color: #FF9800;
      color: white;
    }

    .status-duplicate {
      background-color: #2196F3;
      color: white;
    }

    .status-failed {
      background-color: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <div class="results-container">
    <h1>Gmail Attachment Ingestion Results</h1>

    <div class="summary-box">
      <h2>Batch Summary</h2>
      <div class="summary-stats">
        <div class="stat-item">
          <span>‚úÖ Succeeded:</span>
          <strong id="successCount">0</strong>
        </div>
        <div class="stat-item">
          <span>üîÑ Duplicates:</span>
          <strong id="duplicateCount">0</strong>
        </div>
        <div class="stat-item">
          <span>‚ùå Failed:</span>
          <strong id="failedCount">0</strong>
        </div>
        <div class="stat-item">
          <span>üìä Total:</span>
          <strong id="totalCount">0</strong>
        </div>
      </div>
    </div>

    <div class="actions">
      <a href="/gmail-dev.html" class="btn btn-secondary">‚Üê Back to Gmail Dev</a>
      <a href="/index.html" class="btn btn-primary">View All Reports ‚Üí</a>
    </div>

    <h2>Attachment Details</h2>
    <table class="results-table">
      <thead>
        <tr>
          <th>Filename</th>
          <th>Status</th>
          <th>Details</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="resultsTableBody">
        <!-- Populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <script>
    // Get batchId from URL
    const urlParams = new URLSearchParams(window.location.search);
    const batchId = urlParams.get('batchId');

    if (!batchId) {
      alert('No batch ID provided');
      window.location.href = '/gmail-dev.html';
    }

    // Fetch and display results
    async function loadResults() {
      try {
        const response = await fetch(`/api/dev-gmail/jobs/summary?batchId=${batchId}`);
        const summary = await response.json();

        // Update summary stats
        const newCount = summary.attachments.filter(a => a.status === 'completed').length;
        const updatedCount = summary.attachments.filter(a => a.status === 'updated').length;
        const duplicateCount = summary.attachments.filter(a => a.status === 'duplicate').length;
        const failedCount = summary.attachments.filter(a => a.status === 'failed').length;

        // Combine new + updated as "succeeded"
        document.getElementById('successCount').textContent = newCount + updatedCount;
        document.getElementById('duplicateCount').textContent = duplicateCount;
        document.getElementById('failedCount').textContent = failedCount;
        document.getElementById('totalCount').textContent = summary.totalCount;

        // Populate table
        const tbody = document.getElementById('resultsTableBody');
        tbody.innerHTML = '';

        summary.attachments.forEach(attachment => {
          const row = document.createElement('tr');

          // Status badge
          let statusClass = '';
          if (attachment.status === 'completed') statusClass = 'status-completed';
          else if (attachment.status === 'updated') statusClass = 'status-updated';
          else if (attachment.status === 'duplicate') statusClass = 'status-duplicate';
          else if (attachment.status === 'failed') statusClass = 'status-failed';

          // Actions
          let actions = '-';
          if (attachment.reportId) {
            actions = `<a href="/index.html?reportId=${attachment.reportId}" target="_blank" class="btn btn-sm btn-primary">View Report</a>`;
          }

          row.innerHTML = `
            <td>${attachment.filename}</td>
            <td><span class="status-badge ${statusClass}">${attachment.status}</span></td>
            <td>${attachment.progressMessage}</td>
            <td>${actions}</td>
          `;

          tbody.appendChild(row);
        });

      } catch (error) {
        console.error('Failed to load results:', error);
        alert('Failed to load results: ' + error.message);
      }
    }

    loadResults();
  </script>
</body>
</html>
