<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HealthUp ‚Äî Gmail Integration (Dev)</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <main class="container">
    <nav class="breadcrumb">
      <a href="/" class="breadcrumb-link">‚Üê Back to Main</a>
      <span style="margin: 0 12px; color: #666;">|</span>
      <a href="/admin/pending-analytes" class="breadcrumb-link">‚öôÔ∏è Admin Panel</a>
    </nav>

    <h1>Gmail Integration (Dev)</h1>
    <p class="help-text">Connect your Gmail account to fetch and classify emails that may contain lab test results</p>

    <!-- Connection Status -->
    <section id="connection-section">
      <h2>Connection Status</h2>

      <div id="status-loading" class="loading-state">
        <p>Checking connection...</p>
      </div>

      <div id="status-disconnected" class="empty-state" hidden>
        <p>Not connected to Gmail</p>
        <button id="connect-btn" class="analyze-button">Connect Gmail Account</button>
      </div>

      <div id="status-connected" class="empty-state" hidden>
        <p>‚úÖ Connected to Gmail: <strong id="connected-email"></strong></p>
        <button id="fetch-btn" class="analyze-button">Fetch & Classify Emails</button>
      </div>

      <div id="status-error" class="error-state" hidden>
        <p class="error-message" id="status-error-message"></p>
      </div>
    </section>

    <!-- Results Section -->
    <section id="results-section" hidden>
      <h2>Classification Results</h2>

      <div id="job-loading" class="loading-state">
        <p id="job-progress-text">Processing emails...</p>
        <div style="width: 100%; background: #e5e7eb; border-radius: 8px; height: 24px; margin: 16px 0;">
          <div id="job-progress-bar" style="width: 0%; background: linear-gradient(90deg, #3b82f6, #2563eb); height: 100%; border-radius: 8px; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;"></div>
        </div>
        <p id="job-progress-message" class="help-text">Starting...</p>
      </div>

      <div id="job-error" class="error-state" hidden>
        <p class="error-message" id="job-error-message"></p>
      </div>

      <div id="results-empty" class="empty-state" hidden>
        <p>No recent inbox emails found.</p>
      </div>

      <div id="results-container" hidden>
        <div style="background: #f3f4f6; border-left: 4px solid #3b82f6; padding: 16px; margin-bottom: 20px;">
          <h3 style="margin-top: 0;">üìä Processing Summary (Step-1 ‚Üí Step-2)</h3>
          <div style="margin-bottom: 12px;">
            <strong>Step 1: Metadata Classification</strong>
            <ul style="margin: 4px 0; padding-left: 20px;">
              <li>Total Fetched: <strong id="step1-total">0</strong> emails</li>
              <li>Candidates Found: <strong id="step1-candidates">0</strong></li>
            </ul>
          </div>
          <div style="margin-bottom: 12px;">
            <strong>Step 2: Body Refinement</strong>
            <ul style="margin: 4px 0; padding-left: 20px;">
              <li>Fetched Full Content: <strong id="step2-fetched">0</strong> emails</li>
              <li>Classified with Body: <strong id="step2-classified">0</strong> emails</li>
              <li>‚úÖ Final Lab Results: <strong id="final-results-count">0</strong></li>
            </ul>
          </div>
          <p style="margin: 8px 0; font-size: 14px; color: #666;">
            <strong>Applied Threshold:</strong> LLM confidence ‚â• <span id="threshold-display">70</span>%
          </p>
          <div id="classification-error-warning" hidden></div>
        </div>

        <h3>‚úÖ Final Lab Results (Step-2 Accepted)</h3>
        <table id="results-table" class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Subject</th>
              <th>From</th>
              <th>Date</th>
              <th>Confidence</th>
              <th>Attachments</th>
              <th>Duplicate</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody id="results-tbody">
          </tbody>
        </table>

        <!-- Debug: Step-1 Candidates -->
        <div style="margin-top: 30px;">
          <details open>
            <summary style="cursor: pointer; font-weight: bold; font-size: 16px; margin-bottom: 10px;">
              üîç Debug: Step-1 Candidates (<span id="step1-candidates-count">0</span>)
            </summary>
            <table class="admin-table" style="margin-top: 10px;">
              <thead>
                <tr style="background: #fef3c7;">
                  <th>ID</th>
                  <th>Subject</th>
                  <th>From</th>
                  <th>Date</th>
                  <th>Step-1 Confidence</th>
                  <th>Step-1 Reason</th>
                </tr>
              </thead>
              <tbody id="step1-candidates-tbody">
              </tbody>
            </table>
          </details>
        </div>

        <!-- Debug: Step-2 All Results -->
        <div style="margin-top: 20px;">
          <details open>
            <summary style="cursor: pointer; font-weight: bold; font-size: 16px; margin-bottom: 10px;">
              üîç Debug: Step-2 All Results (Accepted + Rejected) (<span id="step2-all-count">0</span>)
            </summary>
            <table class="admin-table" style="margin-top: 10px;">
              <thead>
                <tr style="background: #fef3c7;">
                  <th>Status</th>
                  <th>ID</th>
                  <th>Subject</th>
                  <th>From</th>
                  <th>Step-2 Clinical?</th>
                  <th>Step-2 Confidence</th>
                  <th>Step-2 Reason</th>
                </tr>
              </thead>
              <tbody id="step2-all-tbody">
              </tbody>
            </table>
          </details>
        </div>

        <!-- Step 3: Attachment Ingestion -->
        <div style="margin-top: 30px;">
          <div
            class="result-section"
            id="step3Section"
            data-allowed-mime="application/pdf,image/png,image/jpeg,image/tiff"
            data-max-size-mb="15"
            style="display:none;"
          >
            <h3>
              <span class="toggle-icon" onclick="toggleSection('step3Content')">‚ñº</span>
              Step 3: Attachment Ingestion
            </h3>
            <div id="step3Content" class="collapsible-content">
              <div class="step3-controls">
                <button id="selectAllBtn" onclick="selectAllAttachments()">Select All</button>
                <button id="deselectAllBtn" onclick="deselectAllAttachments()">Deselect All</button>
                <button id="ingestBtn" onclick="startIngestion()" disabled>Download & Recognize Selected (<span id="selectedCount">0</span>)</button>
              </div>

              <table id="step3Table" class="admin-table">
                <thead>
                  <tr>
                    <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                    <th>Email Details</th>
                    <th>Filename</th>
                    <th>Size</th>
                    <th>Duplicate</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody id="step3TableBody">
                  <!-- Populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container" aria-live="polite"></div>

    <!-- Completion Modal -->
    <div id="completionModal" class="modal" style="display: none;">
      <div class="modal-content">
        <h2>Batch Processing Complete!</h2>
        <div id="completionSummary" style="margin: 20px 0; line-height: 1.8;"></div>
        <p id="redirectCountdown" style="font-size: 14px; color: #666; margin-top: 20px;"></p>
        <button id="closeCompletionModal" class="analyze-button" style="margin-top: 10px;">Close</button>
      </div>
    </div>
  </main>

  <script src="/js/gmail-dev.js"></script>
</body>
</html>
